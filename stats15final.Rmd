---
title: "stats15final"
output:
  pdf_document: default
date: "2022-11-15"
---
[something something intro]
question: what attributes affect how people treat dogs?
analysis: for intakes, more strays and surrender=bad, for outcomes, more adoptions and rto=good
--could possibly make "time in shelter" variable once data is cleaned using datetime?
--attach to intake table; for each intake they spend some amt of time in shelter OR a NA for never leaving/dying??
--transfers: 

# Section 1: Background and Explanation of Data

### The Austin Animal Center
Our data looks at intakes and outcomes of animals in the Austin Animal Center, which is the primary animal shelter for Austin, TX. They accept strays and owned animals regardless of age or health, and they accept all species and breeds of animals. However, for our analysis, we will be solely looking at the intake and outcomes of dogs at the center.

### Intakes and Outcomes
An _intake_ refers to an instance of an animal being admitted to the shelter, whether it be stray or owned. An _outcome_ refers to an animal leaving the shelter for any reason, whether they are adopted, transferred to another shelter, or pass away while staying in the shelter. Our data consists of two separate tables, one detailing outcomes and one detailing intakes. Each animal has a unique ID that is shared between the two tables.

## Variables

+ Note: the variables in the intakes/outcomes tables are very similar but are all described separately here for the sake of clarity

### Explanatory Variables: Intakes Table

***Age.upon.Intake***: (char) the dog’s age at the time of the intake; an estimate if the dog is a rescue

***Breed***: (char) the dog’s primary and secondary breed (if it has one)

***Color***: (char) the dog’s primary and secondary color (if it has one); the one/two main colors that make up its coat

***DateTime***: (char) the date and time of the intake

### Explanatory Variables: Outcomes Table

***Age.upon.Outcome***: (char) the dog’s age at the time of the outcome; an estimate if the dog is a rescue

***Breed***: (char) the dog’s primary and secondary breed (if it has one)

***Color***: (char) the dog’s primary and secondary color (if it has one)

***DateTime***: (char) the date and time of the outcome

### Response Variables

***Outcome.Type***: (char)  the specifics of the outcome situation for the dog, ex: adoption, returned to owner, transferred to rescue shelter

***Intake.Type***: (char)  the specifics of the intake situation for the dog, ex: stray, owner surrender, public assistance (brought in by outside rescue org)

# Section 2: Data Loading, Cleaning, and Modifying

```{r}
library(tidyverse)
library(ggplot2)
```

First, we load our data in.

```{r}
austin_intakes <- read.csv("aac_intakes.csv")
austin_outcomes <- read.csv("aac_outcomes.csv")
```

Then, we of course need to limit our dataset to just dogs.

```{r}
outcomes_filter <- austin_outcomes %>%
  filter(Animal.Type=="Dog")
intakes_filter <- austin_intakes %>% 
  filter(Animal.Type=="Dog")

outcomes_filter %>%
  select(Age.upon.Outcome, Animal.Type, Breed) %>%
  head()
```

Then, we need to eliminate all of the unused columns. The `Animal.Type` column will be unused since we've already filtered to just dogs.

```{r}
outcomes_s <- outcomes_filter %>%
  select(Animal.ID, Age.upon.Outcome, Breed, Color, DateTime, Outcome.Type)
intakes_s <- intakes_filter %>%
  select(Animal.ID, Age.upon.Intake, Breed, Color, DateTime, Intake.Type)

outcomes_s %>% 
  select(Age.upon.Outcome, Breed, Color) %>%
  head()
```

Next, we need to check for any duplicate entries. [TODO]

```{r}

```

Next, the "breed" column: it currently has the problem of being a bit too specific, where some breeds are unmixed, some are just labeled "Mix" while others have the breed mix specified, among other naming specifics; this leads to a large majority of the breed categories having <10 entries.

```{r}
outcomes_s %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=n)) +
  geom_density(fill="light blue") +
  scale_x_log10() +
  xlab("Occurances of each unique breed in data")

outcomes_s %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  summarise(breeds=n())
```

In order for our analysis to be a bit more useful, it will helpful to create less breed categories; we will be removing any "mix" labels and specifying all dog breeds by their primary breed.

```{r}
outcomes_b <- outcomes_s %>% 
  mutate(Breed=str_extract(Breed, "^[A-Za-z ]+")) %>% 
  mutate(Breed=str_replace(Breed, " Mix", ""))
intakes_b <- intakes_s %>% 
  mutate(Breed=str_extract(Breed, "^[A-Za-z ]+")) %>% 
  mutate(Breed=str_replace(Breed, " Mix", ""))

outcomes_b %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=n)) +
  geom_density(fill="light blue") +
  scale_x_log10() +
  xlab("Occurances of each unique breed in data")

outcomes_b %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  summarise(breeds=n())

outcomes_b %>%
  select(Age.upon.Outcome, Breed, Color) %>%
  head()
```

However, we run into a similar problem with the `Color` column.

```{r}
outcomes_b %>%
  group_by(Color) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=n)) +
  geom_density(fill="light blue") +
  #geom_histogram(bins=20, fill="light blue", color="black") +
  scale_x_log10() +
  xlab("Occurances of each unique color in data")

outcomes_b %>%
  group_by(Color) %>%
  summarise(n=n()) %>%
  summarise(unique_colors=n())
```

So, we'll say that any color that makes up less than 1/100th of the data (in other words, less than 800 occurances)will be simplified to be only the first word of the label. The intakes and outcomes tables are similar enough that the counts from the outcomes table will be used as the filter for both.

```{r}
col_occurances <- 
outcomes_b %>%
  group_by(Color) %>%
  summarise(Color.Occurances=n())

outcomes_c <-
  outcomes_b %>%
  left_join(col_occurances, by = "Color") %>%
  mutate(Color=case_when(
    Color.Occurances<800 ~ str_extract(Color, "^[A-Za-z]+"),
    Color.Occurances>=800 ~ Color
  )) %>%
  select(-c(Color.Occurances))

intakes_c <-
  outcomes_b %>%
  left_join(col_occurances, by = "Color") %>%
  mutate(Color=case_when(
    Color.Occurances<800 ~ str_extract(Color, "^[A-Za-z]+"),
    Color.Occurances>=800 ~ Color
  )) %>%
  select(-c(Color.Occurances))

outcomes_c %>%
  group_by(Color) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=n)) +
  geom_density(fill="light blue") +
  scale_x_log10() +
  xlab("Occurances of each unique color in data")

outcomes_c %>%
  group_by(Color) %>%
  summarise(n=n()) %>%
  summarise(unique_colors=n())

outcomes_c %>%
  select(Age.upon.Outcome, Breed, Color) %>%
  head()
```

Next, note that the `Age.upon.Outcome` and `Age.upon.Intake` columns are made up of character strings at the moment

```{r}
outcomes_c %>%
  select(Age.upon.Outcome) %>%
  head()
```

Such a variable will be much easier to analyse as an integer, so we will convert these to integers representing the dog's age in days.

```{r}
conv_to_int <- function(string)
{
  conv <- data.frame(
    c("week", "month", "year"),
    c(7, 30, 365)
  )
  tmp <- 1
  for (n in (1:3))
  {
     if(str_detect(string, conv[n, 1]))
    {
      tmp <- conv[n, 2]
    } 
  }
  ret_str <- str_extract(string, "^[0-9]+")
  ret_int <- as.integer(ret_str)
  return(as.integer(ret_int*tmp))
}

outcomes_c$Age.Days <- map_int(outcomes_c$Age.upon.Outcome, conv_to_int)
intakes_b$Age.Days <- map_int(intakes_b$Age.upon.Intake, conv_to_int)

outcomes_a <- outcomes_c %>%
  select(-c(Age.upon.Outcome)) %>%
  relocate(Age.Days, .before=Breed)
intakes_a <- intakes_b %>%
  select(-c(Age.upon.Intake)) %>%
  relocate(Age.Days, .before=Breed)
         
outcomes_a %>%
  select(Age.Days, Breed, Color) %>%
  head()
```


That will be all for the cleaning of the data, but we will be modifying and adding an additional column to the intakes table.


Note how each animal has a unique ID that is shared across both tables, and additionally, how the specific date and time is given for each intake and outcome. We will be using these in tandem to create a new column for the intakes table that denotes how long each specific intake lasted. For intakes that ended in a death or do not have a corresponding outcome, they will have an NA entry in our new column.

```{r}

```

