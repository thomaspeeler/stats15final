---
title: "stats15final"
output:
  pdf_document: default
date: "2022-12-08"
---
FEEL FREE TO CHANGE ANYTHING UP HERE IN THE INTRODUCTION

IMPORTANT: WHEN PUSHING TO GITHUB, DONT COMMIT TO MAIN!!!!! MAKE A BRANCH!!!
IF YOU DONT KNOW HOW, READ HERE: https://docs.github.com/en/get-started/quickstart/github-flow

---------------------------------------

# Section 1: Background and Explanation of Data

## Introduction and Motivating Question

In the United States alone, 6.5 million dogs, cats, and other former pets are abandoned or lost every year and end up in shelters. In reality, only 3.2 million of these animals are adopted, while others who are not adopted within a certain time frame are euthanized. The Austin Animal Center, however, objects to this quota by being the largest no-kill animal shelter in the United States and providing care and shelter to over 18,000 animals each year. In contrast to other shelters, the animals that are not adopted within a certain time period are either transferred, returned to their original owner, and in very rare cases, euthanized. In this project, we will seek to answer the motivating question: what attributes affect whether a dog is adopted?

## Background

### The Austin Animal Center
The Austin Animal Center is the largest no-kill animal shelter in the United States that provides care and shelter to over 18,000 animals annually. They accept strays and owned animals regardless of age or health, and they accept all species and breeds of animals. However, for our analysis, we will be solely looking at the intake and outcomes of dogs at the center. As part of the AAC's efforts to help and care for animals in need, the organization makes available its accumulated data and statistics as part of the city of Austin's Open Data Initiative. The AAC datasets that we will be analysing outline the intakes and outcomes of animals at the center, of which many happen each day.

### Intakes and Outcomes
An _intake_ refers to an instance of an animal being admitted to the shelter, whether it be stray or owned. An _outcome_ refers to an animal leaving the shelter for any reason, whether they are adopted, transferred to another shelter, or pass away while staying in the shelter. Our data consists of two separate tables, one detailing outcomes and one detailing intakes. Each animal has a unique ID that is shared between the two tables.

### How Animals Come Into the Shelter
Some are brought in by owners who can no longer keep the animals. Others are found roaming the streets and brought in by animal control officers. In an ideal situation, an animal will only stay in a shelter until its owner returns or it is adopted. However, if that is not the case and they don't have enough room to indefinitely house all of the animals they receive, they will transfer them to a partner location.

### Data Structure
The intakes table has one entry for each instance of an animal coming into the shelter, and the outcomes table has one entry for each instance of an animal leaving the shelter. Each entry has details about the intake and outcome situations for the animals, which are specified in the "Variables" section. In our dataset, we will only be looking at dogs. Before any cleaning, the intakes and outcomes tables had a total of 145,851 entries and 145,914 entries, respectively, with 12 variables each.

### Importance of the Data
The importance of this data lies in the fact that it not only identifies characteristics people are looking for in dogs but also helps shelters that house dogs of all kinds decide whether to keep animals that exhibit certain characteristics at their current location or move them to a shelter that specializes in such characteristics. Suppose an elderly dog was staying at a shelter that couldn't get adopted due to a trend of people not adopting elderly dogs. If this was the case, the shelter might be better off transferring the dog to a shelter that is specifically designed for elderly dogs, where people looking to adopt elderly dogs are more likely to adopt the dog.


## Variables

+ Note: the variables started off as being in two separate tables, but the tables will be binded together during cleaning

### Explanatory Variables

***Age.upon.Intake*** and ***Age.upon.Outcome***: (char) the dog’s age at the time of the intake/outcome; an estimate if the dog is a rescue

***Breed***: (char) the dog’s primary and secondary breed (if it has one)

***Color***: (char) the dog’s primary and secondary color (if it has one); the one or two main colors that make up its coat

***DateTime***: (char) the date and time of the intake/outcome

### Response Variable

***Intake.Type*** and ***Outcome.Type***: (char)  the specifics of the intake/outcome situation for the dog, which are: 

outcomes: Adoption, Return to Owner, Transfer (moved to a rescue shelter), Euthanasia, Rto-Adopt (returned to the original owner through the adopotion process), Died, Disposal (same as died), Missing (the dog was lost at the center), and Stolen

intakes: Stray, Owner Surrender, Public Assist (the dog was brought to the shelter by an outside rescue org), Abandoned (there was a confirmed past owner that has abandoned the dog), Euthanasia Request (from the owner or otherwise), and Wildlife (same as stray)

# Section 2: Data Loading and Cleaning

```{r, message=FALSE, echo=FALSE}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(forcats)
```

First, we load our data in.

```{r}
austin_intakes <- read.csv("aac_intakes.csv")
austin_outcomes <- read.csv("aac_outcomes.csv")
```

Then, we of course need to limit our dataset to just dogs.

```{r}
outcomes_filter <- austin_outcomes %>%
  filter(Animal.Type=="Dog")
intakes_filter <- austin_intakes %>% 
  filter(Animal.Type=="Dog")

outcomes_filter %>%
  select(Age.upon.Outcome, Animal.Type, Breed) %>%
  head()
```

Then, we need to eliminate all of the unused columns. The `Animal.Type` column will be unused since we've already filtered to just dogs.

```{r}
outcomes_s <- outcomes_filter %>%
  select(Animal.ID, Age.upon.Outcome, Breed, Color, DateTime, Outcome.Type)
intakes_s <- intakes_filter %>%
  select(Animal.ID, Age.upon.Intake, Breed, Color, DateTime, Intake.Type)

outcomes_s %>% 
  select(Age.upon.Outcome, Breed, Color) %>%
  head()
```

Then, we'll be binding the two tables together for the sake of analysis. An extra column will be added that will specify if each entry is an outcome/intake.

```{r}
o1 <- outcomes_s %>%
  rename("Age"="Age.upon.Outcome",
         "Type"="Outcome.Type")
o1$Action <- "outcome"

i1 <- intakes_s %>%
  rename("Age"="Age.upon.Intake",
         "Type"="Intake.Type")
i1$Action <- "intake"

aac_b <- rbind(o1, i1) %>% arrange(Animal.ID)
aac_b %>%
  select(Age, Breed, Color) %>%
  head()
```

Now, there is some cleaning to do in the `Type` column: some outcome/intake types are very similar to each other, and it will make more sense for our analysis if we lump them all together. Specifically, 

+ `Rto-Adopt` is the same as `Return to Owner`
+ `Wildlife` and `Abandoned` are the same as `Stray`
+ `Disposal` is the same as `Died`
+ `Stolen` is the same as `Lost`.

```{r}
aac_t <-
  aac_b %>%
  mutate(Type=case_when(
    Type=="Rto-Adopt" ~ "Return to Owner",
    Type=="Stolen" ~ "Lost",
    Type=="Disposal" ~ "Died",
    Type %in% c("Wildlife", "Abandoned") ~ "Stray"
  ))
```

Then, we'll use `lubridate` to add a column for all of the `DateTime` values converted to `date` instead of `char` objects, which will make it easier to compare them.

```{r}
aac_d <- aac_t
aac_d$DateTime <- mdy_hms(aac_d$DateTime)

aac_d$DateTime %>%
  head(3)
```

Next, note that the `Age` column is made up of character strings at the moment.

```{r}
aac_c$Age %>%
  head()
```

Such a variable will be much easier to analyse as an integer, so we will convert these to integers representing the dog's age in days.

```{r}
conv_to_int <- function(string)
{
  conv <- data.frame(
    c("week", "month", "year"),
    c(7, 30, 365)
  )
  tmp <- 1
  for (n in (1:3))
  {
     if(str_detect(string, conv[n, 1]))
    {
      tmp <- conv[n, 2]
    } 
  }
  ret_str <- str_extract(string, "^[0-9]+")
  ret_int <- as.integer(ret_str)
  return(as.integer(ret_int*tmp))
}

aac_c$Age.Days <- map_int(aac_c$Age, conv_to_int)

aac_a <- aac_c %>%
  select(-c(Age)) %>%
  relocate(Age.Days, .before=Breed)
         
aac_a$Age.Days %>%
  head()
```

Now, we'll need to do some more careful combing of the data; we'll need to see which animals had intakes/outcomes occur one after the other, without alternating (basically, having two outcomes or two intakes in a row is unusual and illogical but it is present in the data)

```{r}
aac_d %>%
  arrange(Animal.ID, DateTime) %>%
  select(Animal.ID, Action, DateTime, Type) %>%
  head()
```

To help with this part of the cleaning, we'll be adding a column that will specify how long each intake/outcome lasted (in seconds) until the next one for each animal. For the first intake/outcome for an animal, an NA will be in the column. Additionally, we will be adding a column for how many actions the animal has undergone up to the point of that entry.

```{r}
len <- function(d1, d2)
{
  retval <- int_length(interval(d1, d2))
  return(retval)
}

aac_dd <-
aac_d %>%
  arrange(Animal.ID, DateTime) %>%
  group_by(Animal.ID) %>%
  mutate(Num.Action=row_number()) %>%
  ungroup() %>%
  mutate(Time.From.Last.Action=case_when(
    (Num.Action > 1) ~ len(lag(DateTime), DateTime)
  ))

aac_dd %>%
  select(Animal.ID, Action, Time.From.Last.Action, Num.Action) %>%
  head()
```

With that, we can simply remove all cases of duplicate entries (i.e. the time from the last action is 0 and it is the same action as the last)

```{r}
aac_f <-
  aac_dd %>%
  filter((Time.From.Last.Action!=0) | (lag(Action)!=Action) | Num.Action==1) %>%
  arrange(Animal.ID, DateTime) %>%
  mutate(Consecutive=((lag(Action)==Action) & (Num.Action!=1)))
```

Now, there are only 69 "consecutive" entries left after filtering; that is to say, 69 entries that are an `outcome` right after an `outcome` or an `intake` right after an `intake` in the `Action` column. Seeing as our table has over 160,000 entries at the moment, just for the sake of analysis, we will be simply removing these entries from the table.

```{r}
#11/25 NOTE: I DONT KNOW IF THIS IS THE RIGHT THING TO DO; NEED TO ASK MILES ABT IT
aac_r <-
  aac_f  %>%
  filter(!(Consecutive)) %>%
  select(-c(Consecutive))
```

# Section 2.1: Univariate Exploratory Analysis

## Breed

To start, we'll be looking at the `Breed` column.

It currently has the problem of being a bit too specific, where some breeds are unmixed, some are just labeled "Mix" while others have the breed mix specified, among other naming specifics; this leads to a large majority of the breed categories having <10 entries.

```{r}
aac_r %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=n)) +
  geom_density(fill="light blue") +
  scale_x_log10() +
  xlab("Occurances of each unique breed in data")

aac_r %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  summarise(breeds=n())
```

In order for our analysis to be a bit more useful, it will helpful to create less breed categories; we will be removing any "mix" labels and specifying all dogs by their primary breed.

```{r}
aac_b <- aac_r %>% 
  mutate(Breed=str_extract(Breed, "^[A-Za-z ]+")) %>% 
  mutate(Breed=str_replace(Breed, " Mix", ""))

aac_b %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=n)) +
  geom_density(fill="light blue") +
  scale_x_log10() +
  xlab("Occurances of each unique breed in data")

aac_b %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  summarise(breeds=n())

aac_b %>%
  select(Age, Breed, Color) %>%
  head()
```

While there are still some breeds that show up <10 times, they now make up a minority of the data, and our analysis will be far more useful.

Let's look at the distribution of breeds in the data after modification.

```{r}
aac_a %>%
  group_by(Breed) %>%
  summarise(n=n()) %>%
  ggplot(aes(x=fct_rev(fct_reorder(Breed, n)), y=n)) + geom_col(fill="light blue", color="black")  +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  ylab("Appearances in Data") +
  ggtitle("breeds vs how often they appear in the data")
```

The distribution of breeds throughout the data appears *very* right skewed, so there are a small number of breeds that show up far more than any others. Let's look at those at the top:

```{r}
aac_a %>%
  group_by(Breed) %>%
  summarise(appearances=n()) %>%
  arrange(desc(appearances)) %>%
  head(10)
```

[ADD SOURCES FOR THIS PART]
Unsuprisingly, Pit Bulls appear most often in the data, appearing in 24,799 entries out of 163,450 total entries (i.e. nearly a sixth). Pit Bulls are very common in animal shelters, since they tend to have a hard time finding owners due to the aggressive and dangerous reputation of the breed, and they are often abandoned by their owners for the same reason. Retrievers are not far behind Pit Bulls, however dogs of the breed are far more numerous than Pit Bulls, which can account for their many occurances in the data.

[MORE ANALYSIS OF BREED STUFF HERE, IM JUST TOO TIRED TO DO IT RN]


[this is all tentative:]
## Age

[stuff]

## Color

[stuff]

## Time from last Action

[stuff]

## Action Type

[stuff]


# Section 2.2: Multivariate Exploratory Analysis

[stuff]

# Section 3: Data Modeling

[stuff]

# Conclusion

[stuff]
